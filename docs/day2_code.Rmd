---
title: '<span class="en">Day 2: Code</span><span class="de">Tag 2: Code</span>'
subtitle: '<span class="en">R Exercises: Spatial Curves & Comparison</span><span class="de">R-Übungen: Räumliche Kurven & Vergleich</span>'
author: '<span class="en">Ecology Workshop</span><span class="de">Ökologie-Workshop</span>'
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 9, fig.height = 5)
library(tidyverse)
library(knitr)
```

```{css, echo=FALSE}
/* ========== WORKSHOP THEME ========== */

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.7;
  background-color: #fafffe;
}

h1 { color: #2E7D32 !important; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
h2 { color: #388E3C !important; margin-top: 2em; }
h3 { color: #43A047 !important; }

pre { background-color: #f5f5f5 !important; border-left: 4px solid #4CAF50 !important; padding: 15px; padding-top: 35px; border-radius: 8px; position: relative !important; }
code { background-color: #E8F5E9; padding: 2px 6px; border-radius: 4px; color: #2E7D32; }
pre code { background-color: transparent; padding: 0; }

/* Copy button styling */
.copy-btn {
  position: absolute !important;
  top: 8px !important;
  right: 8px !important;
  padding: 4px 12px;
  font-size: 12px;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s, background 0.2s;
  z-index: 100;
}
pre:hover .copy-btn { opacity: 1; }
.copy-btn:hover { background: #2E7D32; }
.copy-btn.copied { background: #1976D2; }

blockquote { border-left: 4px solid #FF9800; background-color: #FFF8E1; padding: 15px 20px; margin: 1em 0; border-radius: 0 8px 8px 0; }

hr { border: none; height: 3px; background: linear-gradient(to right, #4CAF50, #81C784, #C8E6C9, #81C784, #4CAF50); margin: 2em 0; border-radius: 2px; }

.tocify { border: none !important; border-radius: 12px !important; background-color: #f1f8e9 !important; }
.tocify-item.active { background-color: #4CAF50 !important; color: white !important; }

/* Exercise boxes */
.exercise-box {
  background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
  border-left: 5px solid #1976D2;
  padding: 20px;
  margin: 1.5em 0;
  border-radius: 0 12px 12px 0;
}

.exercise-box h4 { color: #1565C0 !important; margin-top: 0; }

/* ========== LANGUAGE TOGGLE ========== */
.lang-toggle {
  position: fixed; top: 10px; right: 20px; z-index: 9999;
  background: linear-gradient(135deg, #2E7D32, #4CAF50);
  padding: 8px 12px; border-radius: 25px;
  box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
}
.lang-toggle button {
  background: transparent; border: none; color: #fff;
  padding: 6px 14px; cursor: pointer; font-weight: bold;
  border-radius: 20px; transition: all 0.3s; font-size: 14px;
}
.lang-toggle button.active { background: white; color: #2E7D32; }
.lang-toggle button:hover:not(.active) { background: rgba(255,255,255,0.2); }

.de { display: none; }
.en { display: inline; }
body.lang-de .de { display: inline; }
body.lang-de .en { display: none; }

div.de, p.de, li.de, h1.de, h2.de, h3.de, h4.de, section.de { display: none; }
div.en, p.en, li.en, h1.en, h2.en, h3.en, h4.en, section.en { display: block; }

body.lang-de div.de, body.lang-de p.de, body.lang-de li.de,
body.lang-de h1.de, body.lang-de h2.de, body.lang-de h3.de,
body.lang-de h4.de, body.lang-de section.de { display: block; }

body.lang-de div.en, body.lang-de p.en, body.lang-de li.en,
body.lang-de h1.en, body.lang-de h2.en, body.lang-de h3.en,
body.lang-de h4.en, body.lang-de section.en { display: none; }

body.lang-de #TOC .en { display: none; }
body.lang-de #TOC .de { display: inline; }
#TOC .de { display: none; }
#TOC .en { display: inline; }

@media print {
  .tocify, .lang-toggle, .copy-btn { display: none; }
}
```

```{js, echo=FALSE}
document.addEventListener('DOMContentLoaded', function() {
  var toggle = document.createElement('div');
  toggle.className = 'lang-toggle';
  toggle.innerHTML = '<button id="btn-en" class="active">EN</button><button id="btn-de">DE</button>';
  document.body.appendChild(toggle);

  var savedLang = localStorage.getItem('workshop-lang');
  var browserLang = navigator.language.substring(0, 2);
  var defaultLang = savedLang || (browserLang === 'de' ? 'de' : 'en');
  if (defaultLang === 'de') setLanguage('de');

  document.getElementById('btn-en').addEventListener('click', function() { setLanguage('en'); });
  document.getElementById('btn-de').addEventListener('click', function() { setLanguage('de'); });

  // Copy button for code blocks
  document.querySelectorAll('pre').forEach(function(pre) {
    var btn = document.createElement('button');
    btn.className = 'copy-btn';
    btn.textContent = 'Copy';

    btn.addEventListener('click', function() {
      var code = pre.querySelector('code');
      var text = code ? code.textContent : pre.textContent;

      function showSuccess() {
        btn.textContent = 'Copied!';
        btn.classList.add('copied');
        setTimeout(function() {
          btn.textContent = 'Copy';
          btn.classList.remove('copied');
        }, 2000);
      }

      function fallbackCopy() {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showSuccess();
        } catch(e) {
          btn.textContent = 'Failed';
        }
        document.body.removeChild(textarea);
      }

      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(showSuccess).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }
    });

    pre.appendChild(btn);
  });

  function setLanguage(lang) {
    document.body.classList.remove('lang-en', 'lang-de');
    document.body.classList.add('lang-' + lang);
    document.getElementById('btn-en').classList.toggle('active', lang === 'en');
    document.getElementById('btn-de').classList.toggle('active', lang === 'de');
    localStorage.setItem('workshop-lang', lang);
  }
});
```

---

# <span class="en">Exercise 1: Load and Prepare Data</span><span class="de">Übung 1: Daten laden und vorbereiten</span>

<div class="exercise-box">

```{r load-all-data}
# Load both datasets
species <- read.csv("../data/austria_species.csv")
plots <- read.csv("../data/austria_header.csv")

# Merge species data with plot locations
data <- merge(species, plots, by = "PlotObservationID")

# Check the result
head(data)
nrow(data)
```

```{r check-coordinates}
# Do we have coordinates?
summary(data$Longitude)
summary(data$Latitude)
```

</div>

---

# <span class="en">Exercise 2: Calculating Distance</span><span class="de">Übung 2: Entfernung berechnen</span>

<div class="exercise-box">

<div class="en">

#### The Distance Formula

Distance between two points (x1, y1) and (x2, y2):

$$d = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}$$

</div>

<div class="de">

#### Die Entfernungsformel

Entfernung zwischen zwei Punkten (x1, y1) und (x2, y2):

$$d = \sqrt{(x_2 - x_1)^2 + (y_2 - y_1)^2}$$

</div>

```{r distance-function}
# Function to calculate distance between two points
calc_distance <- function(x1, y1, x2, y2) {
  sqrt((x2 - x1)^2 + (y2 - y1)^2)
}

# Test it: distance from (0,0) to (3,4) should be 5
calc_distance(0, 0, 3, 4)
```

```{r distance-example}
# Example with real coordinates (in degrees)
# Vienna: 48.2082 N, 16.3738 E
# Graz: 47.0707 N, 15.4395 E

vienna <- c(lon = 16.3738, lat = 48.2082)
graz <- c(lon = 15.4395, lat = 47.0707)

dist_degrees <- calc_distance(vienna["lon"], vienna["lat"],
                              graz["lon"], graz["lat"])
cat("Distance in degrees:", round(dist_degrees, 2), "\n")
cat("Approximate km:", round(dist_degrees * 111, 0), "km\n")  # ~111 km per degree
```

</div>

---

# <span class="en">Exercise 3: For Loops</span><span class="de">Übung 3: For-Schleifen</span>

<div class="exercise-box">

<div class="en">

#### Repeating Actions with Loops

A `for` loop repeats code for each element:

</div>

<div class="de">

#### Aktionen mit Schleifen wiederholen

Eine `for`-Schleife wiederholt Code für jedes Element:

</div>

```{r for-loop-basic}
# Print numbers 1 to 5
for (i in 1:5) {
  print(i)
}
```

```{r for-loop-accumulate}
# Build a cumulative sum manually
values <- c(10, 5, 3, 2, 1)
total <- 0
cumulative <- c()

for (i in 1:length(values)) {
  total <- total + values[i]
  cumulative <- c(cumulative, total)
  cat("After step", i, ": total =", total, "\n")
}

cumulative
```

<div class="en">

We'll use loops to visit plots one by one and track species.

</div>

<div class="de">

Wir werden Schleifen verwenden, um Plots nacheinander zu besuchen und Arten zu verfolgen.

</div>

</div>

---

# <span class="en">Exercise 4: The Complete Algorithm</span><span class="de">Übung 4: Der vollständige Algorithmus</span>

<div class="exercise-box">

```{r build-curve-function}
# Function to build a spatial accumulation curve
build_spatial_curve <- function(data, start_plot) {

  # Get unique plots with their coordinates
  plot_info <- unique(data[, c("PlotObservationID", "Longitude", "Latitude")])
  n_plots <- nrow(plot_info)

  # Initialize
  visited <- c(start_plot)
  current <- start_plot
  species_seen <- unique(data$WFO_TAXON[data$PlotObservationID == start_plot])

  # Results storage
  results <- data.frame(
    step = 1,
    plot_id = start_plot,
    new_species = length(species_seen),
    cumulative = length(species_seen)
  )

  # Visit all other plots in nearest-neighbor order
  for (step in 2:n_plots) {
    # Get current position
    current_pos <- plot_info[plot_info$PlotObservationID == current, ]

    # Find unvisited plots
    unvisited <- plot_info[!plot_info$PlotObservationID %in% visited, ]

    if (nrow(unvisited) == 0) break

    # Calculate distances to all unvisited plots
    distances <- calc_distance(
      current_pos$Longitude, current_pos$Latitude,
      unvisited$Longitude, unvisited$Latitude
    )

    # Go to nearest
    nearest_idx <- which.min(distances)
    next_plot <- unvisited$PlotObservationID[nearest_idx]

    # Count new species
    species_here <- unique(data$WFO_TAXON[data$PlotObservationID == next_plot])
    new_species <- setdiff(species_here, species_seen)
    species_seen <- union(species_seen, species_here)

    # Record results
    results <- rbind(results, data.frame(
      step = step,
      plot_id = next_plot,
      new_species = length(new_species),
      cumulative = length(species_seen)
    ))

    # Update position
    visited <- c(visited, next_plot)
    current <- next_plot
  }

  return(results)
}
```

</div>

---

# <span class="en">Exercise 5: Build Your First Spatial Curve</span><span class="de">Übung 5: Deine erste räumliche Kurve bauen</span>

<div class="exercise-box">

```{r first-spatial-curve}
# Use a subset of data for speed
set.seed(42)
sample_plots <- sample(unique(data$PlotObservationID), 100)
data_sample <- data[data$PlotObservationID %in% sample_plots, ]

# Pick a starting plot
start <- sample_plots[1]

# Build the curve
curve1 <- build_spatial_curve(data_sample, start)

head(curve1)
tail(curve1)
```

```{r plot-first-curve, fig.height=4}
ggplot(curve1, aes(x = step, y = cumulative)) +
  geom_line(color = "#2E7D32", linewidth = 1.5) +
  geom_point(color = "#2E7D32", size = 1, alpha = 0.5) +
  labs(title = "Spatial Accumulation Curve (100 plots)",
       x = "Plots Visited (spatial order)",
       y = "Cumulative Species") +
  theme_minimal(base_size = 14)
```

</div>

---

# <span class="en">Exercise 6: Multiple Seeds</span><span class="de">Übung 6: Mehrere Seeds</span>

<div class="exercise-box">

```{r multiple-seeds}
# Run with 5 different starting points
n_seeds <- 5
all_curves <- list()

set.seed(123)
start_plots <- sample(sample_plots, n_seeds)

for (i in 1:n_seeds) {
  curve <- build_spatial_curve(data_sample, start_plots[i])
  curve$seed <- i
  all_curves[[i]] <- curve
}

# Combine all curves
all_curves_df <- do.call(rbind, all_curves)
```

```{r plot-multiple-seeds, fig.height=4}
ggplot(all_curves_df, aes(x = step, y = cumulative, color = factor(seed))) +
  geom_line(linewidth = 1, alpha = 0.7) +
  scale_color_brewer(palette = "Set1", name = "Seed") +
  labs(title = "Effect of Starting Point on Accumulation Curve",
       subtitle = "5 different starting locations",
       x = "Plots Visited",
       y = "Cumulative Species") +
  theme_minimal(base_size = 14)
```

```{r average-curve, fig.height=4}
# Calculate mean and confidence interval
summary_curve <- all_curves_df %>%
  group_by(step) %>%
  summarize(
    mean_species = mean(cumulative),
    sd_species = sd(cumulative),
    lower = mean_species - 1.96 * sd_species / sqrt(n()),
    upper = mean_species + 1.96 * sd_species / sqrt(n()),
    .groups = "drop"
  )

ggplot(summary_curve, aes(x = step, y = mean_species)) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#4CAF50", alpha = 0.3) +
  geom_line(color = "#2E7D32", linewidth = 1.5) +
  labs(title = "Average Accumulation Curve with 95% CI",
       x = "Plots Visited",
       y = "Cumulative Species") +
  theme_minimal(base_size = 14)
```

</div>

---

# <span class="en">Exercise 7: Native vs. Alien Comparison</span><span class="de">Übung 7: Vergleich Heimisch vs. Alien</span>

## <span class="en">Separate the Data</span><span class="de">Daten trennen</span>

<div class="exercise-box">

```{r separate-native-neo}
# Split data by status
native_data <- data_sample[data_sample$STATUS == "native", ]
neo_data <- data_sample[data_sample$STATUS == "neo", ]

cat("Native observations:", nrow(native_data), "\n")
cat("Neo observations:", nrow(neo_data), "\n")
cat("Native species:", length(unique(native_data$WFO_TAXON)), "\n")
cat("Neo species:", length(unique(neo_data$WFO_TAXON)), "\n")
```

</div>

---

## <span class="en">Build Curves for Both Groups</span><span class="de">Kurven für beide Gruppen bauen</span>

<div class="exercise-box">

```{r build-native-neo-curves}
# Function to build multiple curves and return summary
build_curves_summary <- function(data, n_seeds = 5) {
  sample_plots <- unique(data$PlotObservationID)

  if (length(sample_plots) < 10) {
    return(NULL)  # Not enough plots
  }

  all_curves <- list()
  set.seed(42)
  start_plots <- sample(sample_plots, min(n_seeds, length(sample_plots)))

  for (i in seq_along(start_plots)) {
    curve <- build_spatial_curve(data, start_plots[i])
    curve$seed <- i
    all_curves[[i]] <- curve
  }

  all_df <- do.call(rbind, all_curves)

  # Summarize
  summary_df <- all_df %>%
    group_by(step) %>%
    summarize(
      mean_species = mean(cumulative),
      sd_species = sd(cumulative),
      .groups = "drop"
    )

  return(summary_df)
}

# Build curves for native species
native_summary <- build_curves_summary(native_data, n_seeds = 5)
if (!is.null(native_summary)) native_summary$status <- "Native"

# Build curves for neophyte species
neo_summary <- build_curves_summary(neo_data, n_seeds = 5)
if (!is.null(neo_summary)) neo_summary$status <- "Neo"

# Combine (filter out NULL results)
comparison <- rbind(native_summary, neo_summary)
comparison <- comparison[!is.na(comparison$status), ]
```

```{r plot-comparison, fig.height=5}
ggplot(comparison, aes(x = step, y = mean_species, color = status, fill = status)) +
  geom_ribbon(aes(ymin = mean_species - sd_species,
                  ymax = mean_species + sd_species),
              alpha = 0.2, color = NA) +
  geom_line(linewidth = 1.5) +
  scale_color_manual(values = c("Neo" = "#FF9800", "Native" = "#4CAF50")) +
  scale_fill_manual(values = c("Neo" = "#FF9800", "Native" = "#4CAF50")) +
  labs(title = "Species Accumulation: Native vs. Neo",
       subtitle = "Shaded area shows standard deviation across seeds",
       x = "Plots Visited (spatial order)",
       y = "Cumulative Species",
       color = "Status", fill = "Status") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "top")
```

</div>

---

## <span class="en">Normalize for Fair Comparison</span><span class="de">Normalisieren für fairen Vergleich</span>

<div class="exercise-box">

```{r normalize-curves, fig.height=5}
# Normalize each curve to percentage
comparison_norm <- comparison %>%
  group_by(status) %>%
  mutate(
    max_species = max(mean_species),
    pct_complete = (mean_species / max_species) * 100
  )

ggplot(comparison_norm, aes(x = step, y = pct_complete, color = status)) +
  geom_line(linewidth = 1.5) +
  scale_color_manual(values = c("Neo" = "#FF9800", "Native" = "#4CAF50")) +
  labs(title = "Normalized Accumulation: Native vs. Neo",
       subtitle = "Both curves scaled to percentage of total species found",
       x = "Plots Visited",
       y = "% of Total Species Found",
       color = "Status") +
  theme_minimal(base_size = 14) +
  theme(legend.position = "top")
```

</div>

---

# <span class="en">Summary: R Functions Learned</span><span class="de">Zusammenfassung: Gelernte R-Funktionen</span>

```{r functions-day2, echo=FALSE}
functions <- data.frame(
  Function = c("sqrt()", "for loop", "merge()", "setdiff()", "union()",
               "do.call(rbind, ...)", "group_by() + summarize()"),
  Purpose_EN = c("Square root (for distance)", "Repeat code for each element",
                 "Combine two data frames", "Find elements in A but not B",
                 "Combine unique elements", "Combine list of data frames",
                 "Calculate summaries by group"),
  Purpose_DE = c("Quadratwurzel (für Entfernung)", "Code für jedes Element wiederholen",
                 "Zwei Dataframes kombinieren", "Elemente in A aber nicht in B finden",
                 "Eindeutige Elemente kombinieren", "Liste von Dataframes kombinieren",
                 "Zusammenfassungen nach Gruppe berechnen")
)
kable(functions)
```
