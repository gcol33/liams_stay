---
title: '<span class="en">Day 2: Exercises</span><span class="de">Tag 2: Ãœbungen</span>'
subtitle: '<span class="en">Functions, Plotting & Research Analysis</span><span class="de">Funktionen, Plots & Forschungsanalyse</span>'
author: '<span class="en">Fill in the blanks!</span><span class="de">Fulle die Lucken aus!</span>'
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE, message = FALSE, warning = FALSE)
```

```{=html}
<style>
/* ========== PLAYFUL WORKSHOP THEME ========== */

body {
 font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
 line-height: 1.7;
 background-color: #fafffe;
}

h1 {
 color: #2E7D32 !important;
 border-bottom: 3px solid #4CAF50;
 padding-bottom: 10px;
}

h2 {
 color: #388E3C !important;
 margin-top: 2em;
}

h3 {
 color: #43A047 !important;
}

h4 {
 color: #66BB6A !important;
 border-left: 4px solid #4CAF50;
 padding-left: 10px;
}

/* Code blocks with copy button support */
pre {
 background-color: #f5f5f5 !important;
 border-left: 4px solid #4CAF50 !important;
 padding: 15px;
 padding-top: 35px;
 border-radius: 8px;
 overflow-x: auto;
 position: relative !important;
}

code {
 background-color: #E8F5E9;
 padding: 2px 6px;
 border-radius: 4px;
 color: #2E7D32;
}

pre code {
 background-color: transparent;
 padding: 0;
}

/* Copy button styling */
.copy-btn {
 position: absolute !important;
 top: 8px !important;
 right: 8px !important;
 padding: 4px 12px;
 font-size: 12px;
 background: #4CAF50;
 color: white;
 border: none;
 border-radius: 4px;
 cursor: pointer;
 opacity: 0;
 transition: opacity 0.2s, background 0.2s;
 z-index: 100;
}

pre:hover .copy-btn {
 opacity: 1;
}

.copy-btn:hover {
 background: #2E7D32;
}

.copy-btn.copied {
 background: #1976D2;
}

blockquote {
 border-left: 4px solid #FF9800;
 background-color: #FFF8E1;
 padding: 15px 20px;
 margin: 1em 0;
 border-radius: 0 8px 8px 0;
}

hr {
 border: none;
 height: 3px;
 background: linear-gradient(to right, #4CAF50, #81C784, #C8E6C9, #81C784, #4CAF50);
 margin: 2em 0;
 border-radius: 2px;
}

.tocify {
 border: none !important;
 border-radius: 12px !important;
 background-color: #f1f8e9 !important;
 box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.tocify-item.active, .tocify-item.active:hover {
 background-color: #4CAF50 !important;
 color: white !important;
}

/* Exercise hint */
.hint {
 background-color: #E3F2FD;
 border: 1px solid #1976D2;
 border-radius: 8px;
 padding: 10px 15px;
 margin: 1em 0;
 font-size: 0.9em;
}

.hint::before {
 content: "ðŸ’¡ ";
}

/* ========== LANGUAGE TOGGLE ========== */

.lang-toggle {
 position: fixed;
 top: 10px;
 right: 20px;
 z-index: 9999;
 background: linear-gradient(135deg, #2E7D32, #4CAF50);
 padding: 8px 12px;
 border-radius: 25px;
 box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
}

.lang-toggle button {
 background: transparent;
 border: none;
 color: #fff;
 padding: 6px 14px;
 cursor: pointer;
 font-weight: bold;
 border-radius: 20px;
 transition: all 0.3s;
 font-size: 14px;
}

.lang-toggle button.active {
 background: white;
 color: #2E7D32;
}

.lang-toggle button:hover:not(.active) {
 background: rgba(255,255,255,0.2);
}

.de { display: none; }
.en { display: inline; }

body.lang-de .de { display: inline; }
body.lang-de .en { display: none; }

div.de, p.de, li.de, h1.de, h2.de, h3.de, h4.de, section.de { display: none; }
div.en, p.en, li.en, h1.en, h2.en, h3.en, h4.en, section.en { display: block; }

body.lang-de div.de, body.lang-de p.de, body.lang-de li.de,
body.lang-de h1.de, body.lang-de h2.de, body.lang-de h3.de,
body.lang-de h4.de, body.lang-de section.de { display: block; }

body.lang-de div.en, body.lang-de p.en, body.lang-de li.en,
body.lang-de h1.en, body.lang-de h2.en, body.lang-de h3.en,
body.lang-de h4.en, body.lang-de section.en { display: none; }

body.lang-de #TOC .en { display: none; }
body.lang-de #TOC .de { display: inline; }
#TOC .de { display: none; }
#TOC .en { display: inline; }

@media print {
 .tocify, .lang-toggle, .copy-btn { display: none; }
}
</style>
```

```{=html}
<script>
$(document).ready(function() {
  // Language toggle
  var toggle = $('<div class="lang-toggle"><button id="btn-en" class="active">EN</button><button id="btn-de">DE</button></div>');
  $('body').append(toggle);

  var savedLang = localStorage.getItem('workshop-lang');
  var browserLang = navigator.language.substring(0, 2);
  var defaultLang = savedLang || (browserLang === 'de' ? 'de' : 'en');

  function setLanguage(lang) {
    $('body').removeClass('lang-en lang-de').addClass('lang-' + lang);
    $('#btn-en').toggleClass('active', lang === 'en');
    $('#btn-de').toggleClass('active', lang === 'de');
    localStorage.setItem('workshop-lang', lang);
  }

  if (defaultLang === 'de') {
    setLanguage('de');
  }

  $('#btn-en').click(function() { setLanguage('en'); });
  $('#btn-de').click(function() { setLanguage('de'); });

  // Copy button for code blocks
  $('pre').each(function() {
    var pre = $(this);
    var btn = $('<button class="copy-btn">Copy</button>');

    btn.click(function() {
      var code = pre.find('code');
      var text = code.length ? code.text() : pre.text();

      function showSuccess() {
        btn.text('Copied!').addClass('copied');
        setTimeout(function() {
          btn.text('Copy').removeClass('copied');
        }, 2000);
      }

      function fallbackCopy() {
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          showSuccess();
        } catch(e) {
          btn.text('Failed');
        }
        document.body.removeChild(textarea);
      }

      // Use clipboard API if available and in secure context, else fallback
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(showSuccess).catch(fallbackCopy);
      } else {
        fallbackCopy();
      }
    });

    pre.css('position', 'relative').append(btn);
  });
});
</script>
```

---

# <span class="en">Part 3: Functions and Plotting</span><span class="de">Teil 3: Funktionen und Plotting</span>

## <span class="en">Exercise 9: Writing Functions</span><span class="de">Ubung 9: Funktionen schreiben</span>

<div class="en">

**Task:** Create reusable functions for your analysis!

</div>

<div class="de">

**Aufgabe:** Erstelle wiederverwendbare Funktionen fur deine Analyse!

</div>

```{r}
# Exercise 9: Writing Functions

# 1. Simple function: Calculate area of rectangle
rectangle_area <- function(length, width) {
 area <- ____ * ____
 return(____)
}

# Test it
rectangle_area(5, 10)  # Should be 50

# 2. Function with default argument
greet <- function(name, language = "en") {
 if (language == "en") {
   return(paste("Hello", ____))
 } else if (language == "de") {
   return(paste("Hallo", ____))
 }
}

greet("Anna")              # "Hello Anna"
greet("Anna", "de")        # "Hallo Anna"

# 3. Function returning multiple values
summarize_vector <- function(x) {
 return(list(
   mean = ____(x),
   min = ____(x),
   max = ____(x),
   n = ____(x)
 ))
}

result <- summarize_vector(c(10, 20, 30, 40, 50))
print(result$mean)  # 30

# 4. Function for species richness
count_unique <- function(species_vector) {
 unique_species <- ____(____)
 return(length(____))
}

count_unique(c("Oak", "Beech", "Oak", "Pine"))  # Should be 3
```

<div class="hint">
<span class="en">Function syntax: `function_name <- function(arg1, arg2) { ... return(result) }`</span>
<span class="de">Funktions-Syntax: `function_name <- function(arg1, arg2) { ... return(result) }`</span>
</div>

---

## <span class="en">Exercise 10: Plotting with ggplot2</span><span class="de">Ubung 10: Plotten mit ggplot2</span>

<div class="en">

**Task:** Create publication-ready plots of accumulation curves!

</div>

<div class="de">

**Aufgabe:** Erstelle publikationsreife Plots von Akkumulationskurven!

</div>

```{r}
# Exercise 10: Plotting with ggplot2

library(ggplot2)

# Create example data
curve_data <- data.frame(
 plots = 1:20,
 species = cumsum(c(15, 8, 5, 4, 3, 3, 2, 2, 2, 1,
                    1, 1, 1, 1, 0, 1, 0, 0, 1, 0))
)

# 1. Basic line plot
ggplot(curve_data, aes(x = ____, y = ____)) +
 geom_line()

# 2. Add points and styling
ggplot(curve_data, aes(x = plots, y = species)) +
 geom_line(color = "____", linewidth = ____) +
 geom_point(color = "____", size = ____)

# 3. Add labels and theme
ggplot(curve_data, aes(x = plots, y = species)) +
 geom_line(color = "darkgreen", linewidth = 1.5) +
 labs(
   title = "____",
   x = "____",
   y = "____"
 ) +
 theme_minimal()

# 4. Two groups comparison
comparison_data <- data.frame(
 plots = rep(1:20, 2),
 species = c(
   cumsum(c(20, 10, 6, 4, 3, 2, 2, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0)),
   cumsum(c(8, 5, 3, 2, 2, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0))
 ),
 status = rep(c("Native", "Alien"), each = 20)
)

ggplot(comparison_data, aes(x = plots, y = species, color = ____)) +
 geom_line(linewidth = 1.5) +
 scale_color_manual(values = c("Native" = "____", "Alien" = "____")) +
 labs(
   title = "Species Accumulation: Native vs. Alien",
   x = "Number of Plots",
   y = "Cumulative Species",
   color = "Status"
 ) +
 theme_minimal() +
 theme(legend.position = "____")
```

<div class="hint">
<span class="en">ggplot structure: `ggplot(data, aes(x, y)) + geom_*() + labs() + theme_*()`</span>
<span class="de">ggplot Struktur: `ggplot(data, aes(x, y)) + geom_*() + labs() + theme_*()`</span>
</div>

---

## <span class="en">Exercise 11: Confidence Intervals</span><span class="de">Ubung 11: Konfidenzintervalle</span>

<div class="en">

**Task:** Add confidence bands to show uncertainty!

</div>

<div class="de">

**Aufgabe:** Fuge Konfidenzbander hinzu um Unsicherheit zu zeigen!

</div>

```{r}
# Exercise 11: Confidence Intervals

library(ggplot2)

# Data with confidence intervals
set.seed(42)
ci_data <- data.frame(
 plots = 1:30,
 mean_species = cumsum(c(25, rpois(29, 4)))
)
ci_data$ci_lower <- ci_data$mean_species - runif(30, 2, 8)
ci_data$ci_upper <- ci_data$mean_species + runif(30, 2, 8)

# Plot with ribbon for CI
ggplot(ci_data, aes(x = ____)) +
 geom_ribbon(
   aes(ymin = ____, ymax = ____),
   fill = "darkgreen",
   alpha = ____
 ) +
 geom_line(
   aes(y = ____),
   color = "darkgreen",
   linewidth = ____
 ) +
 labs(
   title = "Accumulation Curve with 95% CI",
   subtitle = "Shaded area shows uncertainty",
   x = "Plots Sampled",
   y = "Species Count"
 ) +
 theme_minimal()
```

<div class="hint">
<span class="en">`geom_ribbon()` creates shaded bands; use `alpha` for transparency (0-1)</span>
<span class="de">`geom_ribbon()` erstellt schattierte Bander; `alpha` fur Transparenz (0-1)</span>
</div>

---

# <span class="en">Part 4: The Research Question</span><span class="de">Teil 4: Die Forschungsfrage</span>

<div class="en">

## Our Hypothesis

**Do alien and native plant species accumulate differently across space?**

We suspect that:

- **Natives** might **saturate faster** - their species pool is already well-represented locally, so nearby plots share many species
- **Aliens** might **accumulate more steadily** - they tend to be patchy, concentrated in disturbed hotspots (roads, cities, agriculture), so you keep finding new ones as you expand spatially

To test this, we'll:
1. Pick a random starting plot (a "seed")
2. Gradually add its nearest neighbours
3. Count how many NEW native vs alien species we find at each step
4. Repeat from many different seeds to see if results depend on starting location

**The shape of the curve tells the story:** A curve that rises steeply then flattens = species are evenly distributed. A curve that rises steadily = species are patchy.

</div>

<div class="de">

## Unsere Hypothese

**Akkumulieren Alien- und heimische Pflanzenarten unterschiedlich uber den Raum?**

Wir vermuten:

- **Heimische** konnten **schneller saturieren** - ihr Artenpool ist lokal bereits gut vertreten, benachbarte Plots teilen viele Arten
- **Aliens** konnten **gleichmassiger akkumulieren** - sie sind fleckenhaft, konzentriert in gestorten Hotspots (Strassen, Stadte, Landwirtschaft), man findet immer neue beim raumlichen Expandieren

Um dies zu testen:
1. Wahle einen zufalligen Startplot (einen "Seed")
2. Fuge schrittweise die nachsten Nachbarn hinzu
3. Zahle wie viele NEUE heimische vs Alien-Arten wir bei jedem Schritt finden
4. Wiederhole von vielen verschiedenen Seeds um zu sehen ob Ergebnisse vom Startort abhangen

**Die Form der Kurve erzahlt die Geschichte:** Eine Kurve die steil steigt dann abflacht = Arten sind gleichmassig verteilt. Eine Kurve die stetig steigt = Arten sind fleckenhaft.

</div>

---

## <span class="en">Exercise 12: Meet the Data</span><span class="de">Ubung 12: Die Daten kennenlernen</span>

<div class="en">

**Goal:** Load the Austrian vegetation data and understand what we're working with.

</div>

<div class="de">

**Ziel:** Lade die osterreichischen Vegetationsdaten und verstehe womit wir arbeiten.

</div>

```{r}
# =============================================================================
# EXERCISE 12: Meet the Data
# =============================================================================

# Load required packages
library(dplyr)
library(ggplot2)

# Load the data files
header <- read.csv("../data/austria_header.csv")
species <- read.csv("../data/austria_species.csv")

# ----- EXPLORE THE HEADER (plot information) -----

# How many vegetation plots do we have?
n_plots <- ____(header)
print(paste("Number of plots:", n_plots))

# What columns are available?
names(header)

# Look at the first few rows
head(header)

# Where are the plots? (coordinate range)
print(paste("Longitude range:",
            round(min(header$Longitude), 2), "to",
            round(max(header$____), 2)))
print(paste("Latitude range:",
            round(min(header$____), 2), "to",
            round(max(header$Latitude), 2)))

# What time period?
print(paste("Year range:", min(header$Year), "to", max(header$____)))

# ----- EXPLORE THE SPECIES DATA -----

# How many species occurrence records?
n_records <- nrow(____)
print(paste("Total species records:", n_records))

# What does a record look like?
head(species)

# THE KEY COLUMN: STATUS (native vs alien)
table(species$____)

# How many UNIQUE species?
n_unique <- length(unique(species$____))
print(paste("Unique species:", n_unique))

# ----- THE BIG QUESTION: How many aliens vs natives? -----

# Count records by status
status_counts <- species %>%
  group_by(STATUS) %>%
  summarise(
    n_records = n(),
    n_species = n_distinct(WFO_TAXON),
    .groups = "drop"
  )
print(status_counts)

# What percentage of RECORDS are aliens?
alien_records <- sum(species$STATUS == "neo")
pct_alien_records <- round(100 * alien_records / nrow(species), 1)
print(paste("Alien records:", pct_alien_records, "%"))

# What percentage of SPECIES are aliens?
alien_spp <- length(unique(species$WFO_TAXON[species$STATUS == "____"]))
native_spp <- length(unique(species$WFO_TAXON[species$STATUS == "____"]))
pct_alien_species <- round(100 * alien_spp / (alien_spp + native_spp), 1)
print(paste("Alien species:", pct_alien_species, "%"))
```

<blockquote>
<span class="en">**Discussion:** Are aliens rare because there are few species, or because each species is rare? What does this tell us about invasion patterns?</span>
<span class="de">**Diskussion:** Sind Aliens selten weil es wenige Arten gibt, oder weil jede Art selten ist? Was sagt uns das uber Invasionsmuster?</span>
</blockquote>

---

## <span class="en">Exercise 13: Map the Plots</span><span class="de">Ubung 13: Die Plots kartieren</span>

<div class="en">

**Goal:** Visualize where our vegetation plots are located in Austria.

</div>

<div class="de">

**Ziel:** Visualisiere wo unsere Vegetationsplots in Osterreich liegen.

</div>

```{r}
# =============================================================================
# EXERCISE 13: Map the Plots
# =============================================================================

library(ggplot2)

# Simple map of plot locations
ggplot(header, aes(x = Longitude, y = Latitude)) +
  geom_point(alpha = 0.3, size = 0.5, color = "darkgreen") +
  coord_quickmap() +  # Preserves aspect ratio for maps
  labs(
    title = "Vegetation Plot Locations in Austria",
    subtitle = paste(nrow(header), "plots"),
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal()

# ----- WHERE ARE THE ALIENS? -----

# First, count aliens per plot
aliens_per_plot <- species %>%
  filter(STATUS == "____") %>%
  group_by(PlotObservationID) %>%
  summarise(n_alien_species = n_distinct(WFO_TAXON), .groups = "drop")

# Merge with header to get coordinates
plot_aliens <- merge(header, aliens_per_plot, by = "____", all.x = TRUE)
plot_aliens$n_alien_species[is.na(plot_aliens$n_alien_species)] <- 0

# Map showing alien richness
ggplot(plot_aliens, aes(x = Longitude, y = Latitude)) +
  geom_point(aes(color = n_alien_species), alpha = 0.5, size = 1) +
  scale_color_gradient(low = "____", high = "____", name = "Alien\nspecies") +
  coord_quickmap() +
  labs(
    title = "Alien Species Richness Across Austria",
    subtitle = "Where are the invasion hotspots?"
  ) +
  theme_minimal()

# ----- STATISTICS: Where are aliens concentrated? -----

# Plots with at least one alien
plots_with_aliens <- sum(plot_aliens$n_alien_species > 0)
pct_invaded <- round(100 * plots_with_aliens / nrow(plot_aliens), 1)
print(paste("Plots with at least 1 alien:", plots_with_aliens,
            "(", pct_invaded, "%)"))

# Mean aliens per invaded plot
mean_aliens <- round(mean(plot_aliens$n_alien_species[plot_aliens$n_alien_species > 0]), 1)
print(paste("Mean aliens per invaded plot:", mean_aliens))

# Maximum aliens in one plot
max_aliens <- max(plot_aliens$n_alien_species)
print(paste("Maximum aliens in one plot:", ____))
```

<blockquote>
<span class="en">**Discussion:** Do you see any spatial patterns in alien richness? Are they random or clustered? What might explain the hotspots?</span>
<span class="de">**Diskussion:** Siehst du raumliche Muster im Alienreichtum? Sind sie zufallig oder geclustert? Was konnte die Hotspots erklaren?</span>
</blockquote>

---

## <span class="en">Exercise 14: Your First Accumulation Curve</span><span class="de">Ubung 14: Deine erste Akkumulationskurve</span>

<div class="en">

**Goal:** Build a species accumulation curve step by step to understand the logic.

</div>

<div class="de">

**Ziel:** Baue eine Artenakkumulationskurve Schritt fur Schritt um die Logik zu verstehen.

</div>

```{r}
# =============================================================================
# EXERCISE 14: Your First Accumulation Curve
# =============================================================================

# We'll work with a small subset first (faster!)
set.seed(42)  # Makes results reproducible
sample_size <- 200

# Pick random plots
sample_plot_ids <- sample(unique(header$PlotObservationID), sample_size)
sample_species <- species %>% filter(PlotObservationID %in% sample_plot_ids)

# ----- BUILD THE CURVE MANUALLY -----

# Shuffle the plot order randomly
plot_order <- sample(sample_plot_ids)

# Track what we've found
found_species <- c()           # Species we've seen so far
accumulation <- numeric(sample_size)  # Running total at each step

# Loop through plots one by one
for (i in 1:sample_size) {

  # Which plot are we visiting?
  current_plot <- plot_order[____]

  # What species are in this plot?
  plot_spp <- sample_species %>%
    filter(PlotObservationID == current_plot) %>%
    pull(WFO_TAXON) %>%
    unique()

  # Which of these are NEW (not seen before)?
  new_spp <- setdiff(plot_spp, ____)

  # Add new species to our found list
  found_species <- c(found_species, new_spp)

  # Record cumulative total
  accumulation[i] <- length(____)

  # Progress update every 50 plots
  if (i %% 50 == 0) {
    cat("After", i, "plots: found", accumulation[i], "species\n")
  }
}

# ----- PLOT THE CURVE -----

curve_data <- data.frame(
  plots_visited = 1:sample_size,
  cumulative_species = ____
)

ggplot(curve_data, aes(x = plots_visited, y = cumulative_species)) +
  geom_line(color = "darkgreen", linewidth = 1.2) +
  geom_point(color = "darkgreen", size = 0.5) +
  labs(
    title = "Species Accumulation Curve",
    subtitle = paste("Random order,", sample_size, "plots"),
    x = "Number of Plots Visited",
    y = "Cumulative Species Found"
  ) +
  theme_minimal()

# ----- KEY METRICS -----

# How many species after 50 plots? 100 plots?
print(paste("Species after 50 plots:", accumulation[50]))
print(paste("Species after 100 plots:", accumulation[____]))
print(paste("Species after all plots:", accumulation[sample_size]))

# Is the curve still rising steeply at the end?
new_in_last_50 <- accumulation[sample_size] - accumulation[sample_size - 50]
print(paste("New species in last 50 plots:", ____))
```

<blockquote>
<span class="en">**Discussion:** Is the curve still rising at the end, or has it flattened? What does this tell us about sampling completeness?</span>
<span class="de">**Diskussion:** Steigt die Kurve am Ende noch, oder ist sie abgeflacht? Was sagt uns das uber die Vollstandigkeit der Probenahme?</span>
</blockquote>

---

## <span class="en">Exercise 15: Natives vs Aliens - First Look</span><span class="de">Ubung 15: Heimische vs Aliens - Erster Blick</span>

<div class="en">

**Goal:** Compare accumulation curves for native and alien species using the same plot order.

</div>

<div class="de">

**Ziel:** Vergleiche Akkumulationskurven fur heimische und Alien-Arten mit derselben Plotreihenfolge.

</div>

```{r}
# =============================================================================
# EXERCISE 15: Natives vs Aliens - First Comparison
# =============================================================================

# Use same sample as before
set.seed(42)
sample_size <- 300
sample_plot_ids <- sample(unique(header$PlotObservationID), sample_size)
sample_species <- species %>% filter(PlotObservationID %in% sample_plot_ids)

# IMPORTANT: Same plot order for both groups!
plot_order <- sample(sample_plot_ids)

# ----- FUNCTION TO BUILD ACCUMULATION CURVE -----

build_accumulation <- function(species_data, plot_order, status_filter = NULL) {

  # Filter by status if specified
  if (!is.null(status_filter)) {
    species_data <- species_data %>% filter(STATUS == status_filter)
  }

  found <- c()
  accum <- numeric(length(plot_order))

  for (i in seq_along(plot_order)) {
    plot_spp <- species_data %>%
      filter(PlotObservationID == plot_order[i]) %>%
      pull(WFO_TAXON) %>%
      unique()

    new_spp <- setdiff(plot_spp, found)
    found <- c(found, new_spp)
    accum[i] <- length(found)
  }

  return(accum)
}

# ----- BUILD SEPARATE CURVES -----

native_curve <- build_accumulation(sample_species, plot_order, "____")
alien_curve <- build_accumulation(sample_species, plot_order, "____")
all_curve <- build_accumulation(sample_species, plot_order, NULL)

# ----- COMBINE FOR PLOTTING -----

comparison <- data.frame(
  plots = rep(1:sample_size, 3),
  species = c(native_curve, alien_curve, all_curve),
  group = rep(c("Native", "Alien", "All"), each = sample_size)
)

# ----- PLOT -----

ggplot(comparison, aes(x = plots, y = species, color = group)) +
  geom_line(linewidth = 1.2) +
  scale_color_manual(
    values = c("Native" = "____", "Alien" = "____", "All" = "gray50"),
    name = "Species\ngroup"
  ) +
  labs(
    title = "Species Accumulation: Native vs Alien",
    subtitle = "Same plots, same order - how do they differ?",
    x = "Number of Plots Visited",
    y = "Cumulative Species"
  ) +
  theme_minimal() +
  theme(legend.position = "right")

# ----- COMPARE THE SHAPES -----

# What fraction of total species found after 100 plots?
native_100 <- native_curve[100]
native_total <- native_curve[sample_size]
alien_100 <- alien_curve[100]
alien_total <- alien_curve[sample_size]

print(paste("Natives: after 100 plots found", native_100, "of", native_total,
            "(", round(100 * native_100/native_total), "%)"))
print(paste("Aliens: after 100 plots found", alien_100, "of", alien_total,
            "(", round(100 * ____/____), "%)"))
```

<blockquote>
<span class="en">**Discussion:** Which group saturates faster? Is this consistent with our hypothesis that natives are more evenly distributed while aliens are patchy?</span>
<span class="de">**Diskussion:** Welche Gruppe saturiert schneller? Ist das konsistent mit unserer Hypothese dass Heimische gleichmassiger verteilt sind wahrend Aliens fleckenhaft sind?</span>
</blockquote>

---

## <span class="en">Exercise 16: The Nearest Neighbour Algorithm</span><span class="de">Ubung 16: Der Nearest-Neighbour-Algorithmus</span>

<div class="en">

**Goal:** Instead of random order, visit plots by walking to the nearest unvisited neighbour. This mimics expanding a sampling area spatially.

</div>

<div class="de">

**Ziel:** Statt zufalliger Reihenfolge, besuche Plots indem du zum nachsten unbesuchten Nachbarn gehst. Dies simuliert das raumliche Erweitern eines Probenahmegebiets.

</div>

```{r}
# =============================================================================
# EXERCISE 16: The Nearest Neighbour Algorithm
# =============================================================================

library(dplyr)

# Work with a subset for speed
set.seed(123)
sample_size <- 300
sample_ids <- sample(unique(header$PlotObservationID), sample_size)
sample_header <- header %>% filter(PlotObservationID %in% sample_ids)
sample_species <- species %>% filter(PlotObservationID %in% sample_ids)

# ----- DISTANCE FUNCTION -----

# Calculate Euclidean distance between two points
calc_distance <- function(x1, y1, x2, y2) {
  sqrt((x2 - x1)^2 + (y2 - y1)^____)
}

# ----- NEAREST NEIGHBOUR WALK -----

nn_walk <- function(header_data, start_idx = NULL) {
  n <- nrow(header_data)

  # Random start if not specified
  if (is.null(start_idx)) {
    start_idx <- sample(1:n, 1)
  }

  visited <- rep(FALSE, n)      # Track which plots visited
  visit_order <- numeric(n)     # Order of visits

  current <- start_idx

  for (i in 1:n) {
    # Visit current plot
    visited[current] <- ____
    visit_order[i] <- header_data$PlotObservationID[current]

    # Find nearest unvisited (if not done)
    if (i < n) {
      # Distances from current to all plots
      distances <- calc_distance(
        header_data$Longitude[current],
        header_data$Latitude[current],
        header_data$____,
        header_data$____
      )

      # Make visited plots "infinitely far"
      distances[visited] <- Inf

      # Move to nearest
      current <- which.min(____)
    }
  }

  return(visit_order)
}

# ----- GET NEAREST NEIGHBOUR ORDER -----

nn_order <- nn_walk(sample_header)

# ----- BUILD CURVES WITH NN ORDER -----

native_nn <- build_accumulation(sample_species, nn_order, "native")
alien_nn <- build_accumulation(sample_species, nn_order, "alien")

# Compare with random order
random_order <- sample(sample_ids)
native_random <- build_accumulation(sample_species, random_order, "native")
alien_random <- build_accumulation(sample_species, random_order, "alien")

# ----- PLOT COMPARISON -----

comparison <- data.frame(
  plots = rep(1:sample_size, 4),
  species = c(native_nn, alien_nn, native_random, alien_random),
  group = rep(c("Native (spatial)", "Alien (spatial)",
                "Native (random)", "Alien (random)"), each = sample_size),
  method = rep(c("Spatial", "Spatial", "Random", "Random"), each = sample_size),
  status = rep(c("Native", "Alien", "Native", "Alien"), each = sample_size)
)

ggplot(comparison, aes(x = plots, y = species, color = status, linetype = method)) +
  geom_line(linewidth = 1) +
  scale_color_manual(values = c("Native" = "darkgreen", "Alien" = "red")) +
  scale_linetype_manual(values = c("Spatial" = "solid", "Random" = "dashed")) +
  labs(
    title = "Spatial vs Random Accumulation",
    subtitle = "Does visiting nearest neighbours change the pattern?",
    x = "Number of Plots Visited",
    y = "Cumulative Species"
  ) +
  theme_minimal()
```

<blockquote>
<span class="en">**Discussion:** Do the spatial curves (solid) accumulate slower than random (dashed)? Why? This is called "spatial autocorrelation" - nearby places are more similar than random places.</span>
<span class="de">**Diskussion:** Akkumulieren die raumlichen Kurven (durchgezogen) langsamer als zufallige (gestrichelt)? Warum? Dies nennt man "raumliche Autokorrelation" - nahe Orte sind ahnlicher als zufallige Orte.</span>
</blockquote>

---

## <span class="en">Exercise 17: Multiple Seeds - Does Starting Point Matter?</span><span class="de">Ubung 17: Mehrere Seeds - Ist der Startpunkt wichtig?</span>

<div class="en">

**Goal:** Run the nearest neighbour algorithm from many different starting points to see how much results vary.

</div>

<div class="de">

**Ziel:** Fuhre den Nearest-Neighbour-Algorithmus von vielen verschiedenen Startpunkten aus um zu sehen wie stark die Ergebnisse variieren.

</div>

```{r}
# =============================================================================
# EXERCISE 17: Multiple Seeds
# =============================================================================

# Parameters
n_seeds <- 30  # Number of different starting points
sample_size <- 200

# Sample plots
set.seed(42)
sample_ids <- sample(unique(header$PlotObservationID), sample_size)
sample_header <- header %>% filter(PlotObservationID %in% sample_ids)
sample_species <- species %>% filter(PlotObservationID %in% sample_ids)

# ----- RUN FROM MULTIPLE SEEDS -----

# Storage for results
native_runs <- matrix(NA, nrow = n_seeds, ncol = sample_size)
alien_runs <- matrix(NA, nrow = n_seeds, ncol = sample_size)

cat("Running", n_seeds, "seeds...\n")

for (seed in 1:n_seeds) {
  # Get NN order from this starting point
  nn_order <- nn_walk(sample_header, start_idx = seed)

  # Build curves
  native_runs[seed, ] <- build_accumulation(sample_species, nn_order, "native")
  alien_runs[seed, ] <- build_accumulation(sample_species, nn_order, "____")

  if (seed %% 10 == 0) cat("Completed seed", seed, "\n")
}

# ----- CALCULATE MEAN AND RANGE -----

native_mean <- apply(native_runs, 2, ____)
native_lower <- apply(native_runs, 2, function(x) quantile(x, 0.025))
native_upper <- apply(native_runs, 2, function(x) quantile(x, 0.975))

alien_mean <- apply(alien_runs, 2, mean)
alien_lower <- apply(alien_runs, 2, function(x) quantile(x, ____))
alien_upper <- apply(alien_runs, 2, function(x) quantile(x, ____))

# ----- PLOT WITH UNCERTAINTY -----

summary_data <- data.frame(
  plots = rep(1:sample_size, 2),
  mean = c(native_mean, alien_mean),
  lower = c(native_lower, alien_lower),
  upper = c(native_upper, alien_upper),
  status = rep(c("Native", "Alien"), each = sample_size)
)

ggplot(summary_data, aes(x = plots)) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = status), alpha = 0.3) +
  geom_line(aes(y = mean, color = status), linewidth = 1.2) +
  scale_color_manual(values = c("Native" = "darkgreen", "Alien" = "red")) +
  scale_fill_manual(values = c("Native" = "darkgreen", "Alien" = "red")) +
  labs(
    title = "Accumulation Curves from Multiple Starting Points",
    subtitle = paste(n_seeds, "different seeds - shaded area shows 95% range"),
    x = "Number of Plots Visited (Nearest Neighbour Order)",
    y = "Cumulative Species"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

# ----- HOW MUCH VARIATION? -----

# Coefficient of variation at 100 plots
native_cv <- round(100 * sd(native_runs[, 100]) / mean(native_runs[, 100]), 1)
alien_cv <- round(100 * sd(alien_runs[, 100]) / mean(alien_runs[, 100]), 1)

print(paste("Variation at 100 plots - Native CV:", native_cv, "%, Alien CV:", alien_cv, "%"))
```

<blockquote>
<span class="en">**Discussion:** Which group shows more variation between seeds? High variation means the pattern depends strongly on where you start - suggesting patchy distribution.</span>
<span class="de">**Diskussion:** Welche Gruppe zeigt mehr Variation zwischen Seeds? Hohe Variation bedeutet das Muster hangt stark davon ab wo man startet - was auf fleckenhafte Verteilung hindeutet.</span>
</blockquote>

---

## <span class="en">Exercise 18: Comparing Curve Shapes</span><span class="de">Ubung 18: Kurvenformen vergleichen</span>

<div class="en">

**Goal:** Quantify the difference in curve shapes. Do aliens really accumulate more "steadily"?

</div>

<div class="de">

**Ziel:** Quantifiziere den Unterschied in Kurvenformen. Akkumulieren Aliens wirklich "gleichmassiger"?

</div>

```{r}
# =============================================================================
# EXERCISE 18: Comparing Curve Shapes
# =============================================================================

# ----- METRIC 1: Saturation point -----
# At what point have you found 80% of species?

find_saturation <- function(curve, threshold = 0.8) {
  total <- max(curve)
  target <- total * threshold
  which(curve >= target)[1]
}

# Calculate for each seed
native_sat <- apply(native_runs, 1, find_saturation, threshold = 0.8)
alien_sat <- apply(alien_runs, 1, find_saturation, threshold = 0.8)

# Express as percentage of plots needed
native_sat_pct <- 100 * native_sat / sample_size
alien_sat_pct <- 100 * alien_sat / sample_size

print(paste("Plots to reach 80% - Native:", round(mean(native_sat_pct)),
            "%, Alien:", round(mean(____)), "%"))

# ----- METRIC 2: Initial slope vs final slope -----
# Steep start + flat end = fast saturation
# Steady throughout = patchy distribution

calc_slopes <- function(curve) {
  n <- length(curve)

  # First 20% of plots
  early_end <- round(n * 0.2)
  early_slope <- (curve[early_end] - curve[1]) / early_end

  # Last 20% of plots
  late_start <- round(n * 0.8)
  late_slope <- (curve[n] - curve[late_start]) / (n - late_start)

  # Ratio: high = saturates fast
  if (late_slope > 0) {
    return(early_slope / late_slope)
  } else {
    return(Inf)
  }
}

native_slope_ratio <- apply(native_runs, 1, calc_slopes)
alien_slope_ratio <- apply(alien_runs, 1, ____)

# Remove Inf values for comparison
native_ratio_clean <- native_slope_ratio[is.finite(native_slope_ratio)]
alien_ratio_clean <- alien_slope_ratio[is.finite(alien_slope_ratio)]

print(paste("Slope ratio (early/late) - Native:", round(mean(native_ratio_clean), 1),
            ", Alien:", round(mean(alien_ratio_clean), 1)))
print("Higher ratio = steeper start relative to end = faster saturation")

# ----- VISUALIZE THE METRICS -----

metrics <- data.frame(
  saturation_pct = c(native_sat_pct, alien_sat_pct),
  status = rep(c("Native", "Alien"), each = n_seeds)
)

ggplot(metrics, aes(x = status, y = saturation_pct, fill = status)) +
  geom_boxplot() +
  scale_fill_manual(values = c("Native" = "darkgreen", "Alien" = "red")) +
  labs(
    title = "How quickly do species saturate?",
    subtitle = "Percentage of plots needed to find 80% of species",
    y = "% of Plots Needed",
    x = ""
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

<blockquote>
<span class="en">**Discussion:** A lower saturation percentage means species are found faster (more evenly distributed). Does this support or contradict our hypothesis?</span>
<span class="de">**Diskussion:** Ein niedrigerer Saturationsprozentsatz bedeutet Arten werden schneller gefunden (gleichmassiger verteilt). Unterstutzt oder widerspricht das unserer Hypothese?</span>
</blockquote>

---

## <span class="en">Exercise 19: Where You Start Matters - Mapping Seed Effects</span><span class="de">Ubung 19: Wo man startet ist wichtig - Seed-Effekte kartieren</span>

<div class="en">

**Goal:** Does the starting location affect how many aliens vs natives you find? Map the "alien advantage" across Austria.

</div>

<div class="de">

**Ziel:** Beeinflusst der Startort wie viele Aliens vs Heimische man findet? Kartiere den "Alien-Vorteil" uber Osterreich.

</div>

```{r}
# =============================================================================
# EXERCISE 19: Mapping Seed Effects
# =============================================================================

# We'll calculate alien:native ratio after a fixed number of plots
# for each starting point

n_seeds <- 50
n_plots_check <- 100  # Check ratio after this many plots

set.seed(42)
sample_ids <- sample(unique(header$PlotObservationID), 300)
sample_header <- header %>% filter(PlotObservationID %in% sample_ids)
sample_species <- species %>% filter(PlotObservationID %in% sample_ids)

# Storage
seed_results <- data.frame(
  seed_idx = 1:n_seeds,
  seed_plot = NA,
  seed_lon = NA,
  seed_lat = NA,
  native_at_100 = NA,
  alien_at_100 = NA
)

cat("Analyzing", n_seeds, "starting points...\n")

for (i in 1:n_seeds) {
  # Run from this seed
  nn_order <- nn_walk(sample_header, start_idx = i)

  # Store seed location
  seed_results$seed_plot[i] <- sample_header$PlotObservationID[i]
  seed_results$seed_lon[i] <- sample_header$Longitude[i]
  seed_results$seed_lat[i] <- sample_header$Latitude[i]

  # Build curves
  native_curve <- build_accumulation(sample_species, nn_order, "native")
  alien_curve <- build_accumulation(sample_species, nn_order, "alien")

  # Record values at checkpoint
  seed_results$native_at_100[i] <- native_curve[min(n_plots_check, length(native_curve))]
  seed_results$alien_at_100[i] <- alien_curve[min(n_plots_check, length(alien_curve))]
}

# Calculate alien proportion (relative to total found)
seed_results$alien_proportion <- seed_results$alien_at_100 /
  (seed_results$native_at_100 + seed_results$____)

# ----- MAP THE RESULTS -----

ggplot(seed_results, aes(x = seed_lon, y = seed_lat)) +
  geom_point(aes(color = alien_proportion), size = 3) +
  scale_color_gradient2(
    low = "darkgreen",
    mid = "yellow",
    high = "____",
    midpoint = mean(seed_results$alien_proportion),
    name = "Alien\nproportion"
  ) +
  coord_quickmap() +
  labs(
    title = "How Starting Location Affects Alien Detection",
    subtitle = paste("Alien proportion after", n_plots_check, "plots (nearest neighbour)"),
    x = "Longitude",
    y = "Latitude"
  ) +
  theme_minimal()

# ----- WHICH STARTING POINTS FIND MOST ALIENS? -----

top_alien_seeds <- seed_results %>%
  arrange(desc(alien_proportion)) %>%
  head(5)

print("Top 5 starting points for finding aliens:")
print(top_alien_seeds[, c("seed_lon", "seed_lat", "alien_at_100", "native_at_100")])
```

<blockquote>
<span class="en">**Discussion:** Are there geographic patterns? Do some regions consistently find more aliens? What might explain these patterns (cities, agriculture, roads)?</span>
<span class="de">**Diskussion:** Gibt es geografische Muster? Finden manche Regionen konsistent mehr Aliens? Was konnte diese Muster erklaren (Stadte, Landwirtschaft, Strassen)?</span>
</blockquote>

---

## <span class="en">Exercise 20: The Complete Analysis</span><span class="de">Ubung 20: Die komplette Analyse</span>

<div class="en">

**Goal:** Put it all together - a publication-ready analysis with proper replication and uncertainty quantification.

</div>

<div class="de">

**Ziel:** Alles zusammenfugen - eine publikationsreife Analyse mit korrekter Replikation und Unsicherheitsquantifizierung.

</div>

```{r}
# =============================================================================
# EXERCISE 20: The Complete Analysis
# =============================================================================

library(dplyr)
library(ggplot2)

# ----- PARAMETERS -----
n_seeds <- 50          # Different starting points
sample_size <- 400     # Plots per run
set.seed(2024)

# ----- SAMPLE DATA -----

sample_ids <- sample(unique(header$PlotObservationID), sample_size)
sample_header <- header %>% filter(PlotObservationID %in% sample_ids)
sample_species <- species %>% filter(PlotObservationID %in% sample_ids)

# ----- RUN FULL ANALYSIS -----

native_curves <- matrix(NA, nrow = n_seeds, ncol = sample_size)
alien_curves <- matrix(NA, nrow = n_seeds, ncol = sample_size)

cat("Running full analysis with", n_seeds, "seeds and", sample_size, "plots each...\n")

for (seed in 1:n_seeds) {
  nn_order <- nn_walk(sample_header, start_idx = seed)
  native_curves[seed, ] <- build_accumulation(sample_species, nn_order, "native")
  alien_curves[seed, ] <- build_accumulation(sample_species, nn_order, "alien")
  if (seed %% 10 == 0) cat("  Seed", seed, "complete\n")
}

# ----- SUMMARIZE -----

results <- data.frame(
  plots = rep(1:sample_size, 2),
  mean = c(apply(native_curves, 2, mean), apply(alien_curves, 2, mean)),
  lower = c(apply(native_curves, 2, function(x) quantile(x, 0.025)),
            apply(alien_curves, 2, function(x) quantile(x, 0.025))),
  upper = c(apply(native_curves, 2, function(x) quantile(x, 0.975)),
            apply(alien_curves, 2, function(x) quantile(x, 0.975))),
  status = rep(c("Native", "Alien"), each = sample_size)
)

# ----- FINAL PLOT -----

p <- ggplot(results, aes(x = plots)) +
  geom_ribbon(aes(ymin = lower, ymax = upper, fill = status), alpha = 0.25) +
  geom_line(aes(y = mean, color = status), linewidth = 1.3) +
  scale_color_manual(
    values = c("Native" = "#228B22", "Alien" = "#DC143C"),
    name = ""
  ) +
  scale_fill_manual(
    values = c("Native" = "#228B22", "Alien" = "#DC143C"),
    name = ""
  ) +
  labs(
    title = "Species Accumulation: Native vs Alien Plants in Austria",
    subtitle = paste0("Nearest-neighbour sampling from ", n_seeds,
                      " starting points (95% CI shown)"),
    x = "Number of Plots Sampled",
    y = "Cumulative Species Count",
    caption = "Data: Austrian vegetation plots | Method: Nearest-neighbour spatial accumulation"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    legend.position = c(0.85, 0.2),
    legend.background = element_rect(fill = "white", color = "gray80"),
    plot.title = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )

print(p)

# Save the plot
# ggsave("austria_accumulation_curves.png", p, width = 10, height = 7, dpi = 300)

# ----- FINAL STATISTICS -----

cat("\n===== RESULTS SUMMARY =====\n\n")

# Total species found
cat("Species found:\n")
cat("  Native:", round(mean(native_curves[, sample_size])),
    "(range:", min(native_curves[, sample_size]), "-", max(native_curves[, sample_size]), ")\n")
cat("  Alien:", round(mean(alien_curves[, sample_size])),
    "(range:", min(alien_curves[, sample_size]), "-", max(alien_curves[, sample_size]), ")\n\n")

# Saturation comparison
native_sat <- apply(native_curves, 1, find_saturation, threshold = 0.8)
alien_sat <- apply(alien_curves, 1, find_saturation, threshold = 0.8)

cat("Plots to reach 80% of species:\n")
cat("  Native:", round(mean(native_sat)), "plots (", round(100*mean(native_sat)/sample_size), "%)\n")
cat("  Alien:", round(mean(alien_sat)), "plots (", round(100*mean(alien_sat)/sample_size), "%)\n\n")

# Variation between seeds
cat("Variation between starting points (CV at 200 plots):\n")
cat("  Native:", round(100 * sd(native_curves[,200]) / mean(native_curves[,200]), 1), "%\n")
cat("  Alien:", round(100 * sd(alien_curves[,200]) / mean(alien_curves[,200]), 1), "%\n")
```

<blockquote>
<span class="en">**Final Discussion:**
1. Do the results support our hypothesis about natives saturating faster than aliens?
2. What does the variation between seeds tell us about alien distribution?
3. What would you want to investigate next? (Climate? Land use? Specific regions?)
</span>
<span class="de">**Abschlussdiskussion:**
1. Unterstutzen die Ergebnisse unsere Hypothese dass Heimische schneller saturieren als Aliens?
2. Was sagt uns die Variation zwischen Seeds uber die Alienverteilung?
3. Was wurdest du als nachstes untersuchen wollen? (Klima? Landnutzung? Bestimmte Regionen?)
</span>
</blockquote>

---

# <span class="en">Quick Reference</span><span class="de">Schnellreferenz</span>

<div class="en">

| Function | Purpose |
|----------|---------|
| `c()` | Combine values into vector |
| `length()` | Count elements |
| `unique()` | Get unique values |
| `setdiff(a, b)` | Elements in a but not in b |
| `cumsum()` | Cumulative sum |
| `sqrt()` | Square root |
| `which.min()` | Index of minimum |
| `subset()` | Filter data |
| `ggplot()` | Create plot |
| `geom_line()` | Add line |
| `geom_ribbon()` | Add confidence band |

</div>

<div class="de">

| Funktion | Zweck |
|----------|-------|
| `c()` | Werte zu Vektor kombinieren |
| `length()` | Elemente zahlen |
| `unique()` | Einzigartige Werte |
| `setdiff(a, b)` | Elemente in a aber nicht in b |
| `cumsum()` | Kumulative Summe |
| `sqrt()` | Quadratwurzel |
| `which.min()` | Index des Minimums |
| `subset()` | Daten filtern |
| `ggplot()` | Plot erstellen |
| `geom_line()` | Linie hinzufugen |
| `geom_ribbon()` | Konfidenzband hinzufugen |

</div>
